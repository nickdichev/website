---
/**
 * Lava Lamp Background Effect
 *
 * Creates a subtle animated background with morphing gradient blobs.
 * - Uses SVG filter for the "goo" merge effect
 * - Respects prefers-reduced-motion
 * - Provides noscript fallback
 * - Mouse interaction pushes blobs gently
 */
---

<!-- SVG Filter Definition (hidden) -->
<svg class="hidden" aria-hidden="true">
  <defs>
    <filter id="goo-filter">
      <feGaussianBlur in="SourceGraphic" stdDeviation="40" result="blur" />
      <feColorMatrix
        in="blur"
        mode="matrix"
        values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 20 -10"
        result="goo"
      />
    </filter>
  </defs>
</svg>

<!-- Animated Background Container -->
<div class="lava-lamp-container" aria-hidden="true" data-lava-lamp>
  <div class="lava-lamp-wrapper">
    <!-- Each blob has a mouse-offset wrapper and an animated inner -->
    <div class="blob-mouse-layer" data-blob-mouse>
      <div class="blob blob-1"></div>
    </div>
    <div class="blob-mouse-layer" data-blob-mouse>
      <div class="blob blob-2"></div>
    </div>
    <div class="blob-mouse-layer" data-blob-mouse>
      <div class="blob blob-3"></div>
    </div>
    <div class="blob-mouse-layer" data-blob-mouse>
      <div class="blob blob-4"></div>
    </div>
    <div class="blob-mouse-layer" data-blob-mouse>
      <div class="blob blob-5"></div>
    </div>
  </div>
</div>

<!-- Static fallback for noscript -->
<noscript>
  <div class="lava-lamp-static" aria-hidden="true"></div>
</noscript>

<style>
  .lava-lamp-container {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
    background-color: rgb(var(--color-background));
  }

  .lava-lamp-wrapper {
    position: absolute;
    inset: -200px;
    filter: url(#goo-filter);
  }

  /* Mouse layer handles cursor interaction transform */
  .blob-mouse-layer {
    position: absolute;
    inset: 0;
    will-change: transform;
    transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .blob {
    position: absolute;
    border-radius: 50%;
    opacity: 0.25;
    will-change: transform;
  }

  /* Blob colors using the warm palette */
  .blob-1 {
    width: 45vmax;
    height: 45vmax;
    top: -10%;
    left: -10%;
    background: radial-gradient(
      circle at 30% 30%,
      rgb(var(--color-primary-light)) 0%,
      rgb(var(--color-primary-light) / 0.5) 50%,
      transparent 70%
    );
    animation: float-1 25s ease-in-out infinite;
  }

  .blob-2 {
    width: 35vmax;
    height: 35vmax;
    top: 50%;
    right: -5%;
    background: radial-gradient(
      circle at 70% 30%,
      rgb(var(--color-secondary-light)) 0%,
      rgb(var(--color-secondary-light) / 0.5) 50%,
      transparent 70%
    );
    animation: float-2 30s ease-in-out infinite;
  }

  .blob-3 {
    width: 30vmax;
    height: 30vmax;
    bottom: -5%;
    left: 30%;
    background: radial-gradient(
      circle at 50% 70%,
      rgb(var(--color-accent-light)) 0%,
      rgb(var(--color-accent-light) / 0.5) 50%,
      transparent 70%
    );
    animation: float-3 20s ease-in-out infinite;
  }

  .blob-4 {
    width: 25vmax;
    height: 25vmax;
    top: 20%;
    left: 50%;
    background: radial-gradient(
      circle at 40% 40%,
      rgb(var(--color-primary-dark)) 0%,
      rgb(var(--color-primary-dark) / 0.4) 50%,
      transparent 70%
    );
    animation: float-4 22s ease-in-out infinite;
  }

  .blob-5 {
    width: 20vmax;
    height: 20vmax;
    bottom: 20%;
    left: 10%;
    background: radial-gradient(
      circle at 60% 60%,
      rgb(var(--color-secondary-dark)) 0%,
      rgb(var(--color-secondary-dark) / 0.4) 50%,
      transparent 70%
    );
    animation: float-5 28s ease-in-out infinite;
  }

  /* Dark mode adjustments */
  :global(.dark) .blob {
    opacity: 0.18;
  }

  :global(.dark) .blob-1 {
    background: radial-gradient(
      circle at 30% 30%,
      rgb(var(--color-primary-dark)) 0%,
      rgb(var(--color-primary-dark) / 0.5) 50%,
      transparent 70%
    );
  }

  :global(.dark) .blob-2 {
    background: radial-gradient(
      circle at 70% 30%,
      rgb(var(--color-secondary-dark)) 0%,
      rgb(var(--color-secondary-dark) / 0.5) 50%,
      transparent 70%
    );
  }

  :global(.dark) .blob-3 {
    background: radial-gradient(
      circle at 50% 70%,
      rgb(var(--color-accent-dark)) 0%,
      rgb(var(--color-accent-dark) / 0.5) 50%,
      transparent 70%
    );
  }

  :global(.dark) .blob-4 {
    background: radial-gradient(
      circle at 40% 40%,
      rgb(var(--color-primary-light)) 0%,
      rgb(var(--color-primary-light) / 0.4) 50%,
      transparent 70%
    );
  }

  :global(.dark) .blob-5 {
    background: radial-gradient(
      circle at 60% 60%,
      rgb(var(--color-secondary-light)) 0%,
      rgb(var(--color-secondary-light) / 0.4) 50%,
      transparent 70%
    );
  }

  /* Keyframe animations - slow, organic movements */
  @keyframes float-1 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(10%, 15%) scale(1.05);
    }
    50% {
      transform: translate(5%, 25%) scale(0.95);
    }
    75% {
      transform: translate(-5%, 10%) scale(1.02);
    }
  }

  @keyframes float-2 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    33% {
      transform: translate(-15%, -10%) scale(1.08);
    }
    66% {
      transform: translate(-10%, 15%) scale(0.92);
    }
  }

  @keyframes float-3 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    20% {
      transform: translate(15%, -20%) scale(1.1);
    }
    40% {
      transform: translate(25%, -10%) scale(0.9);
    }
    60% {
      transform: translate(10%, -25%) scale(1.05);
    }
    80% {
      transform: translate(-5%, -15%) scale(0.95);
    }
  }

  @keyframes float-4 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    50% {
      transform: translate(-20%, 20%) scale(1.15);
    }
  }

  @keyframes float-5 {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(20%, -10%) scale(0.9);
    }
    50% {
      transform: translate(15%, 15%) scale(1.1);
    }
    75% {
      transform: translate(-10%, 5%) scale(0.95);
    }
  }

  /* Reduced motion: stop animations but keep visual */
  @media (prefers-reduced-motion: reduce) {
    .blob {
      animation: none !important;
    }
    .blob-mouse-layer {
      transition: none !important;
    }
  }

  /* Static fallback for noscript */
  .lava-lamp-static {
    position: fixed;
    inset: 0;
    z-index: -1;
    background:
      radial-gradient(
        ellipse 50% 50% at 20% 20%,
        rgb(var(--color-primary-light) / 0.2) 0%,
        transparent 50%
      ),
      radial-gradient(
        ellipse 40% 40% at 80% 60%,
        rgb(var(--color-secondary-light) / 0.2) 0%,
        transparent 50%
      ),
      radial-gradient(
        ellipse 35% 35% at 50% 90%,
        rgb(var(--color-accent-light) / 0.15) 0%,
        transparent 50%
      );
  }

  :global(.dark) .lava-lamp-static {
    background:
      radial-gradient(
        ellipse 50% 50% at 20% 20%,
        rgb(var(--color-primary-dark) / 0.15) 0%,
        transparent 50%
      ),
      radial-gradient(
        ellipse 40% 40% at 80% 60%,
        rgb(var(--color-secondary-dark) / 0.15) 0%,
        transparent 50%
      ),
      radial-gradient(
        ellipse 35% 35% at 50% 90%,
        rgb(var(--color-accent-dark) / 0.12) 0%,
        transparent 50%
      );
  }
</style>

<script is:inline>
  // Mouse interaction for lava lamp blobs - "push away" effect
  (function initLavaLamp() {
    // Respect reduced motion preference
    var prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    ).matches;

    if (prefersReducedMotion) return;

    var container = document.querySelector("[data-lava-lamp]");
    if (!container) return;

    var mouseLayers = container.querySelectorAll("[data-blob-mouse]");
    if (mouseLayers.length === 0) return;

    // Configuration
    var pushRadius = 512; // How close cursor needs to be to push (pixels)
    var pushStrength = 64; // Max push distance (pixels)
    var easingSpeed = 0.05; // How fast blobs return (0-1, lower = smoother)

    // Approximate blob center positions (percentage of viewport)
    // These match the CSS positioning of each blob
    var blobPositions = [
      { x: 0.15, y: 0.15 },  // blob-1: top-left
      { x: 0.85, y: 0.55 },  // blob-2: right side
      { x: 0.45, y: 0.85 },  // blob-3: bottom center
      { x: 0.55, y: 0.30 },  // blob-4: upper center
      { x: 0.20, y: 0.70 },  // blob-5: bottom-left
    ];

    // Store layer data
    var layerData = [];
    for (var i = 0; i < mouseLayers.length; i++) {
      layerData.push({
        element: mouseLayers[i],
        baseX: blobPositions[i] ? blobPositions[i].x : 0.5,
        baseY: blobPositions[i] ? blobPositions[i].y : 0.5,
        currentX: 0,
        currentY: 0,
        targetX: 0,
        targetY: 0,
      });
    }

    var mouseX = -1000;
    var mouseY = -1000;
    var rafId = null;

    function handleMouseMove(e) {
      mouseX = e.clientX;
      mouseY = e.clientY;
    }

    function handleMouseLeave() {
      mouseX = -1000;
      mouseY = -1000;
    }

    // Animation loop
    function animate() {
      var vw = window.innerWidth;
      var vh = window.innerHeight;

      for (var i = 0; i < layerData.length; i++) {
        var data = layerData[i];

        // Calculate blob's approximate center in pixels
        var blobCenterX = data.baseX * vw;
        var blobCenterY = data.baseY * vh;

        // Calculate distance from cursor to blob center
        var dx = blobCenterX - mouseX;
        var dy = blobCenterY - mouseY;
        var distance = Math.sqrt(dx * dx + dy * dy);

        // Calculate pull if within radius
        if (distance < pushRadius && distance > 0) {
          // Normalize direction (negative = pull toward cursor)
          var nx = -dx / distance;
          var ny = -dy / distance;

          // Pull strength falls off with distance (stronger when closer)
          var force = (1 - distance / pushRadius) * pushStrength;

          data.targetX = nx * force;
          data.targetY = ny * force;
        } else {
          // Return to original position
          data.targetX = 0;
          data.targetY = 0;
        }

        // Smooth interpolation toward target
        data.currentX += (data.targetX - data.currentX) * easingSpeed;
        data.currentY += (data.targetY - data.currentY) * easingSpeed;

        // Apply transform to the wrapper layer
        data.element.style.transform = "translate(" + data.currentX + "px, " + data.currentY + "px)";
      }

      rafId = requestAnimationFrame(animate);
    }

    // Start listening and animating
    document.addEventListener("mousemove", handleMouseMove, { passive: true });
    document.addEventListener("mouseleave", handleMouseLeave);
    rafId = requestAnimationFrame(animate);

    // Cleanup on page navigation (for Astro view transitions)
    document.addEventListener("astro:before-preparation", function cleanup() {
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseleave", handleMouseLeave);
      if (rafId) cancelAnimationFrame(rafId);
    }, { once: true });
  })();
</script>
